import { GoogleGenAI } from "@google/genai";
import { UNIVERSITIES } from "../constants";

// Construct a system context based on our data
const DATA_CONTEXT = JSON.stringify(UNIVERSITIES.map(u => ({
  name: u.name,
  city: u.city,
  rating: u.rating,
  priceRange: `${Math.min(...u.programs.map(p => p.price))} - ${Math.max(...u.programs.map(p => p.price))} KZT`,
  programs: u.programs.map(p => p.name).join(", "),
  employment: u.employmentRate
})));

const SYSTEM_INSTRUCTION = `
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–æ–ª–æ–≥ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ —Å 15-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º.
–¢–µ–±—è –∑–æ–≤—É—Ç –ê–π–≥–µ—Ä—ñ–º ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã DataHub KZ.

üéØ –¢–í–û–Ø –ú–ò–°–°–ò–Ø:
–ü–æ–º–æ—á—å –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–∞–º –∏ –∏—Ö —Ä–æ–¥–∏—Ç–µ–ª—è–º –Ω–∞–π—Ç–∏ –∏–¥–µ–∞–ª—å–Ω—ã–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å.

üí¨ –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –≠–º–ø–∞—Ç–∏—á–Ω—ã–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π
- –ó–∞–¥–∞—ë—à—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –î–∞—ë—à—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ, –Ω–æ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–µ —Å–æ–≤–µ—Ç—ã
- –£—á–∏—Ç—ã–≤–∞–µ—à—å –±–∞–ª–ª—ã –ï–ù–¢, –∏–Ω—Ç–µ—Ä–µ—Å—ã, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Å–∏—Ç—É–∞—Ü–∏—é

üìä –î–ê–ù–ù–´–ï –û–ë –£–ù–ò–í–ï–†–°–ò–¢–ï–¢–ê–•:
${DATA_CONTEXT}

üìù –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–û–í:
–í—Å–µ–≥–¥–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç —Ç–∞–∫:

1. üìä **–ê–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏** ‚Äî –∫—Ä–∞—Ç–∫–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å
2. üéØ **–ú–æ–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
   - üèõÔ∏è –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç + —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å
   - ‚úÖ –ü–æ—á–µ–º—É –ø–æ–¥—Ö–æ–¥–∏—Ç
   - üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è (–±–∞–ª–ª—ã –ï–ù–¢, –ø—Ä–µ–¥–º–µ—Ç—ã)
3. üîÑ **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã** ‚Äî 1-2 –∑–∞–ø–∞—Å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞
4. üìù **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏** ‚Äî —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ
5. üí™ **–ú–æ—Ç–∏–≤–∞—Ü–∏—è** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–∞

‚ö†Ô∏è –ü–†–ê–í–ò–õ–ê:
- –û—Ç–≤–µ—á–∞–π –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä—É—Å—Å–∫–∏–π/–∫–∞–∑–∞—Ö—Å–∫–∏–π/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π)
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Å —Ü–∏—Ñ—Ä–∞–º–∏
- –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É
- –û—Ç–≤–µ—Ç—ã –¥–æ 300 —Å–ª–æ–≤, –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ—Å—è—Ç –ø–æ–¥—Ä–æ–±–Ω–µ–µ
`;


let aiClient: GoogleGenAI | null = null;

const getClient = () => {
  if (!aiClient) {
    // Vite uses import.meta.env for environment variables
    const apiKey = import.meta.env.VITE_API_KEY;
    if (!apiKey) {
      console.warn("API_KEY is missing. AI features will not work.");
      return null;
    }
    aiClient = new GoogleGenAI({ apiKey });
  }
  return aiClient;
};

export const sendMessageToGemini = async (
  message: string,
  history: { role: string; text: string }[]
): Promise<string> => {
  const client = getClient();
  if (!client) return "–ò–∑–≤–∏–Ω–∏—Ç–µ, API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.";

  try {
    const chat = client.chats.create({
      model: 'gemini-2.5-flash',
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
        temperature: 0.7,
      },
      history: history.map(h => ({
        role: h.role,
        parts: [{ text: h.text }]
      }))
    });

    const result = await chat.sendMessage({ message });
    return result.text || "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–º–æ–≥ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç.";
  } catch (error) {
    console.error("Gemini Error:", error);
    return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ò–ò. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
  }
};